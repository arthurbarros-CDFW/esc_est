#ask for chops
chops.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "Do you have CHOPS on 1st Capture data NOT represented as '2' in capture histories?")
if(chops.ask == "YES"){
chops<-read.csv(choose.files(caption="Select your CHOPS data (.csv file)"), head=T, as.is=T)
}
#ask for covars
covars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "Do you have COVARIATE data?")
if(covars.ask == "YES"){
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
} else {
sex <- NULL
length <- NULL
}
#ask for unequal timing
#see Mrawin.f90 (https://github.com/tmcd82070/MRA/blob/master/src/Mrawin.f90)
#line 1270 incorporated in prosur
ints.equal <- select.list(c("YES",
"NO"),
multiple = FALSE,
graphics = FALSE,
title = "Are all intervals between occasions equal?")
if(ints.equal == "NO"){
ints = read.csv(choose.files(caption="Select the file containing lengths of un-equal time intervals (.csv file)"),
head=T, as.is=T)
ints <- ints[,grep("[0-9]",names(ints))]
ints <- unlist(ints)  # must be a vector, not a data frame
# at this point ch may have other columns in it
if( length(ints) != (ncol(ch)-2) ){
stop("Number of time intervals must be 1 less than number of sampling occasions")
}
if( any(ints == 0) ){
stop("Zero time intervals are not allowed.")
}
} else {
ints = rep(1,ncol(ch)-2)
}
#ask about subsampling
#this is driven by LAR having to subsample every other fish in high return years
sampling.unequal <- select.list(c("YES",
"NO"),
multiple = FALSE,
graphics = FALSE,
title = "Where there any periods when subsampling was performed?")
if(sampling.unequal == "YES"){
sub.sampling = read.csv(choose.files(caption="Select the file containing records of subsampling (.csv file)"),
head=T, as.is=T)
sub.sampling <- sub.sampling[,grep("[0-9]",names(sub.sampling))]
sub.sampling <- unlist(sub.sampling)  # must be a vector, not a data frame
# at this point ch may have other columns in it
if( length(sub.sampling) != (ncol(ch)-1) ){
stop("Number of records must equal number of sampling periods.")
}
if( any(ints == 0) ){
stop("Zero sampling periods is not allowed.")
}
} else {
sub.sampling = rep(1,ncol(ch)-1)
}
#Part 2: prepare ch and covars data
ch=ch[-1] #remove disctag vector from capture histories
null_matrix<-matrix(1,nrow=nrow(ch),ncol=ncol(ch))
if(covars.ask == "YES"){
covars$sex<-as.numeric(ifelse(covars$sex%in%c('F',"f"),1,0)) #change sex to numeric value
covars$length<-as.numeric(covars$length)
}
View(covars)
if(covars.ask == "YES"){
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
} else {
sex <- NULL
length <- NULL
}
#ask for unequal timing
#see Mrawin.f90 (https://github.com/tmcd82070/MRA/blob/master/src/Mrawin.f90)
#line 1270 incorporated in prosur
ints.equal <- select.list(c("YES",
"NO"),
multiple = FALSE,
graphics = FALSE,
title = "Are all intervals between occasions equal?")
if(covars.ask == "YES"){
covars$sex<-as.numeric(ifelse(covars$sex%in%c('F',"f"),1,0)) #change sex to numeric value
covars$length<-as.numeric(covars$length)
}
covars.ask
as.numeric(ifelse(covars$sex%in%c('F',"f"),1,0))
str(covars$Sex)
#standardize field names
names(covars) <- tolower(names(covars))
covars$sex<-as.numeric(ifelse(covars$sex%in%c('F',"f"),1,0)) #change sex to numeric value
covars$length<-as.numeric(covars$length)
source("scripts/CVCS_functions.R")
results<-CJS_run()
suppressWarnings(rm("ch","chops","covars"))#remove objects
#Part 1: select data prompts
#ask for CH
ch<-read.csv(choose.files(caption="Select your CAPTURE HISTORY data (.csv file)"), head=T, as.is=T)
if(covars.ask == "YES"){
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
} else {
sex <- NULL
length <- NULL
}
View(ch)
View(covars)
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
nrow(ch)
nrow(covars)
source("scripts/CVCS_functions.R")
results<-CJS_run()
?select.list
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
missing_in_covars
ch<-ch%>%filter(disctag!=missing_in_covars)
source("scripts/CVCS_functions.R")
results<-CJS_run()
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
source("scripts/CVCS_functions.R")
results<-CJS_run()
results<-CJS_run()
results<-CJS_run()
suppressWarnings(rm("ch","chops","covars"))#remove objects
#Part 1: select data prompts
#ask for CH
ch<-read.csv(choose.files(caption="Select your CAPTURE HISTORY data (.csv file)"), head=T, as.is=T)
chops<-read.csv(choose.files(caption="Select your CHOPS data (.csv file)"), head=T, as.is=T)
#ask for covars
covars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "Do you have COVARIATE data?")
if(covars.ask == "YES"){
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
} else {
sex <- NULL
length <- NULL
}
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
#Part 1: select data prompts
#ask for CH
ch<-read.csv(choose.files(caption="Select your CAPTURE HISTORY data (.csv file)"), head=T, as.is=T)
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%filter(disctag!=missing_in_covars)
#Part 1: select data prompts
#ask for CH
ch<-read.csv(choose.files(caption="Select your CAPTURE HISTORY data (.csv file)"), head=T, as.is=T)
ch2<-ch%>%
filter(disctag!=missing_in_covars)
View(ch2)
View(covars)
source("scripts/CVCS_functions.R")
results<-CJS_run()
results<-CJS_run()
results<-CJS_run()
results<-CJS_run()
#ask for data if needed, check if already exists
refreshData <- TRUE
if (exists("prepped_data")){
new.data <- select.list(c("Keep the 'CURRENT' data file sets",
"Load 'NEW' data file sets"),
multiple = FALSE,
graphics = FALSE,
title = "Which Data Files to Use?")
refreshData <- substr(new.data,1,4)=="Load"
}
#run CJS_data_prep()
if(refreshData==TRUE){
prepped_data<-CJS_data_prep()
assign("prepped_data", prepped_data, pos=.GlobalEnv) # save for next round, possibly
}
#select one or more model
models = c(	"constant capture and survival rates",
"constant capture rate and survival related the sex",
"constant capture rate and survival related the length",
"capture related to sex and constant survival rate",
"capture related to length and constant survival rate",
"capture related to sex and survival related to length",
"capture related to length and survival related to sex",
"capture related to sex and survival related to sex",
"capture related to length and survival related to length")
model_fit<-CJS_model_select(prepped_data$covars_ask,
prepped_data$sex_matrix,
prepped_data$lengths_matrix,
prepped_data$ch)
c_hat = 1
initial_beta=numeric(4)
model_results=data.frame()
model_fit$models_ran
i=7
#est_escapement = NaN when i=6 (cap~sex, surv~length)
#this seems to be because the fill_prob_matrices is producing all 1s for length covariates?
#this is produced in the pro_capsur function
#seems to be because of exp(cap_beta[1]*1+cap_beta[2]*cap_X[i,j])
#the beta parameters are way high when using length
#this only seems to happen for this model variant for this data?
#note it doesn't happen with Trent's application
#skip for now (3/26/2025)
print(paste("beginning model:",i," (",
models[i],")",sep=""))
model_num=i
starttime<-Sys.time()
{gc()
optim_results<-cpp_optim(beta=initial_beta,
ch=as.matrix(prepped_data$ch),
cap_X=as.matrix(model_fit$cap_X[[i]]),
surv_X=as.matrix(model_fit$surv_X[[i]]),
ints=as.matrix(prepped_data$intervals))
}
initial_beta
as.matrix(prepped_data$ch)
source("scripts/CVCS_functions.R")
results<-CJS_run()
results<-CJS_run()
results<-CJS_run()
View(results)
source("scripts/CVCS_functions.R")
results<-CJS_run()
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%
filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
any(is.na(covars$length))
View(covars)
any(is.null(covars$length))
#check covars for na values
if(any(is.null(covars$length)) | any(is.na(covars$Length))){
warning(paste("Found", sum(is.na(covars$length)),
"NA values in Length. These rows will be removed."))
# Remove rows with NA length
covars <- covars[!is.na(covars$length), ]
# Also remove corresponding rows from ch
ch <- ch[ch$disctag %in% covars$disctag, ]
}
missing_lengths<-covars%>%filter(is.null(length))
View(missing_lengths)
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%
filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
missing_lengths<-covars%>%filter(is.null(length))
covars%>%filter(is.null(length))
any(is.null(covars$length))
any(is.na(covars$length))
missing_lengths<-covars%>%filter(is.null(Length))
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
#standardize field names
names(covars) <- tolower(names(covars))
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%
filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
#Part 1: select data prompts
#ask for CH
ch<-read.csv(choose.files(caption="Select your CAPTURE HISTORY data (.csv file)"), head=T, as.is=T)
#standardize field names
names(covars) <- tolower(names(covars))
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%
filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
any(is.null(covars$length))
any(is.na(covars$length))
#check covars for na values
if(any(is.null(covars$length)) | any(is.na(covars$length))){
missing_lengths<-covars%>%filter(is.null(length))
warning(paste("Found", sum(is.na(covars$length)),
"NA values in Length. These rows will be removed."))
# Remove rows with NA length
covars <- covars[!is.na(covars$length), ]
# Also remove corresponding rows from ch
ch <- ch[ch$disctag %in% covars$disctag, ]
}
missing_lengths
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
#standardize field names
names(covars) <- tolower(names(covars))
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%
filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
#Part 1: select data prompts
#ask for CH
ch<-read.csv(choose.files(caption="Select your CAPTURE HISTORY data (.csv file)"), head=T, as.is=T)
#standardize field names
names(covars) <- tolower(names(covars))
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%
filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
any(is.null(covars$length))
any(is.na(covars$length))
missing_lengths<-covars%>%filter(is.null(length))
missing_lengths
missing_lengths<-covars%>%filter(is.null(length)|is.na(length))
missing_lengths
warning(paste("Found", sum(is.na(covars$length)),
"NA values in Length. These rows will be removed."))
# Remove rows with NA length
covars2 <- filter(!is.null(length)|!is.na(length))
# Remove rows with NA length
covars2 <- filter(is.null(length)|is.na(length))
# Remove rows with NA length
covars2 <- covars%>%filter(!is.null(length)|!is.na(length))
View(covars2)
# Remove rows with NA length
covars2 <- covars%>%filter(!is.null(length)|!is.na(length))
# Remove rows with NA length
covars2 <- covars%>%filter(!is.null(length)|is.na(length))
missing_lengths
# Remove rows with NA length
covars2 <- covars%>%filter(disctag %in% missing_lengths$disctag)
# Remove rows with NA length
covars2 <- covars%>%filter(!disctag %in% missing_lengths$disctag)
# Also remove corresponding rows from ch
ch <- ch%>%filter(!disctag %in% missing_lengths$disctag)
any(is.null(covars$sex)
any(is.null(covars$sex))
any(is.na(covars$sex))
missing_sex<-covars%>%filter(is.null(sex)|is.na(sex))
missing_sex
warning(paste("Found", sum(is.na(covars$sex)),
"NA values in Length. These rows will be removed."))
# Remove rows with NA length
covars <- covars%>%filter(!disctag %in% missing_sex$disctag)
# Also remove corresponding rows from ch
ch <- ch%>%filter(!disctag %in% missing_lengths$disctag)
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%
filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
missing_lengths<-covars%>%filter(is.null(length)|is.na(length))
warning(paste("Found", sum(is.na(covars$length)),
"NA values in length. These rows will be removed."))
# Remove rows with NA length
covars <- covars%>%filter(!disctag %in% missing_lengths$disctag)
missing_sex<-covars%>%filter(is.null(sex)|is.na(sex))
warning(paste("Found", sum(is.na(covars$sex)),
"NA values in sex. These rows will be removed."))
# Remove rows with NA length
covars <- covars%>%filter(!disctag %in% missing_sex$disctag)
# Also remove corresponding rows from ch
ch <- ch%>%filter(!disctag %in% missing_lengths$disctag)
suppressWarnings(rm("ch","chops","covars"))#remove objects
#Part 1: select data prompts
#ask for CH
ch<-read.csv(choose.files(caption="Select your CAPTURE HISTORY data (.csv file)"), head=T, as.is=T)
covars<-read.csv(choose.files(caption="Select your COVARIATE data (.csv file)"), head=T, as.is=T)
#standardize field names
names(covars) <- tolower(names(covars))
if( nrow(covars) < nrow(ch) ){
dropcovars.ask<-select.list(c(	"YES",
"NO"),
graphics = FALSE,
multiple = FALSE, title = "The number of covariate records does not match the number of capture history records. Would you like to drop capture history records missing covariate records?")
if(dropcovars.ask == "YES"){
missing_in_covars <- ch$disctag[!ch$disctag %in% covars$disctag]
ch<-ch%>%
filter(disctag!=missing_in_covars)
} else {
stop("Number of covariate records must be the same as the number of capture history records")
}
} else if(nrow(covars)>nrow(ch)){
stop("Number of covariate records must be the same as the number of capture history records")
}
#check covars for na values
if(any(is.null(covars$length)) | any(is.na(covars$length))){
missing_lengths<-covars%>%filter(is.null(length)|is.na(length))
warning(paste("Found", sum(is.na(covars$length)),
"NA values in length. These rows will be removed."))
# Remove rows with NA length
covars <- covars%>%filter(!disctag %in% missing_lengths$disctag)
# Also remove corresponding rows from ch
ch <- ch%>%filter(!disctag %in% missing_lengths$disctag)
}
if(any(is.null(covars$sex)) | any(is.na(covars$sex))){
missing_sex<-covars%>%filter(is.null(sex)|is.na(sex))
warning(paste("Found", sum(is.na(covars$sex)),
"NA values in sex. These rows will be removed."))
# Remove rows with NA length
covars <- covars%>%filter(!disctag %in% missing_sex$disctag)
# Also remove corresponding rows from ch
ch <- ch%>%filter(!disctag %in% missing_lengths$disctag)
}
View(ch)
View(covars)
# Also remove corresponding rows from ch
ch <- ch%>%filter(!disctag %in% missing_sex$disctag)
#quick esc_est testing
#created: 12/23/2025
#last update: 12/23/2025
rm( list = ls()) #clear env
library(tidyverse)
library(escapeMR)
library(Rcpp)
source("scripts/CVCS_functions.R")
results<-CJS_run()
View(results)
results<-CJS_run()
#quick esc_est testing
#created: 12/23/2025
#last update: 12/23/2025
rm( list = ls()) #clear env
library(tidyverse)
library(escapeMR)
library(Rcpp)
source("scripts/CVCS_functions.R")
results<-CJS_run()
results<-CJS_run()
614/60
results<-CJS_run()
results<-CJS_run()
View(results)
